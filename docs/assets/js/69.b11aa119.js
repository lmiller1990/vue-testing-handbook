(window.webpackJsonp = window.webpackJsonp || []).push([[69], { 276: function (t, s, a) { "use strict"; a.r(s); var n = a(0), e = Object(n.a)({}, (function () { var t = this, s = t.$createElement, a = t._self._c || s; return a("ContentSlotsDistributor", { attrs: { "slot-key": t.$parent.slotKey } }, [a("div", { staticClass: "custom-block tip" }, [a("p", { staticClass: "custom-block-title" }, [t._v("Это руководство было написано для Vue.js 2 и Vue Test Utils v1.")]), t._v(" "), a("p", [t._v("Версия для Vue.js 3 "), a("a", { attrs: { href: "/v3/ru" } }, [t._v("здесь")]), t._v(".")])]), t._v(" "), a("h2", { attrs: { id: "тестирование-действий" } }, [a("a", { staticClass: "header-anchor", attrs: { href: "#тестирование-действий" } }, [t._v("#")]), t._v(" Тестирование действий")]), t._v(" "), a("p", [t._v("Тестировать действия в изоляции очень просто. Это очень похоже на тестирование мутаций в изоляции – смотрите "), a("a", { attrs: { href: "https://lmiller1990.github.io/vue-testing-handbook/ru/vuex-mutations.html", target: "_blank", rel: "noopener noreferrer" } }, [t._v("здесь"), a("OutboundLink")], 1), t._v(" про тестирование мутаций. Тестирование диспетчеризации действий в контексте компонента обсуждалось "), a("a", { attrs: { href: "https://lmiller1990.github.io/vue-testing-handbook/ru/vuex-in-components-mutations-and-actions.html", target: "_blank", rel: "noopener noreferrer" } }, [t._v("здесь"), a("OutboundLink")], 1), t._v(".")]), t._v(" "), a("p", [t._v("Исходный код для теста на этой странице можно найти "), a("a", { attrs: { href: "https://github.com/lmiller1990/vue-testing-handbook/tree/master/demo-app/tests/unit/actions.spec.js", target: "_blank", rel: "noopener noreferrer" } }, [t._v("здесь"), a("OutboundLink")], 1), t._v(".")]), t._v(" "), a("h2", { attrs: { id: "создание-действия" } }, [a("a", { staticClass: "header-anchor", attrs: { href: "#создание-действия" } }, [t._v("#")]), t._v(" Создание действия")]), t._v(" "), a("p", [t._v("Мы напишем действие, которое следует обычному Vuex паттерну:")]), t._v(" "), a("ol", [a("li", [t._v("делаем асинхронный запрос к API")]), t._v(" "), a("li", [t._v("обрабатываем данные (опционально)")]), t._v(" "), a("li", [t._v("делаем "), a("code", [t._v("commit")]), t._v(" мутации с результатом в виде нагрузки")])]), t._v(" "), a("p", [t._v("Вот действие "), a("code", [t._v("authenticate")]), t._v(", которое отправляет имя пользователя и пароль к внешнему API, в котором проверяется совпадают ли они. Затем результат используется для обновления хранилища, путём выполнения мутации "), a("code", [t._v("SET_AUTHENTICATED")]), t._v(" с результатом в виде нагрузки.")]), t._v(" "), a("div", { staticClass: "language-js extra-class" }, [a("pre", { pre: !0, attrs: { class: "language-js" } }, [a("code", [a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("import")]), t._v(" axios "), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("from")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token string" } }, [t._v('"axios"')]), t._v("\n\n"), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("export")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("default")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("{")]), t._v("\n  "), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("async")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token function" } }, [t._v("authenticate")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token parameter" } }, [a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("{")]), t._v(" commit "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("}")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(",")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("{")]), t._v(" username"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(",")]), t._v(" password "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("}")])]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("{")]), t._v("\n    "), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("const")]), t._v(" authenticated "), a("span", { pre: !0, attrs: { class: "token operator" } }, [t._v("=")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("await")]), t._v(" axios"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(".")]), a("span", { pre: !0, attrs: { class: "token function" } }, [t._v("post")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token string" } }, [t._v('"/api/authenticate"')]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(",")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("{")]), t._v("\n      username"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(",")]), t._v(" password\n    "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("}")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v("\n\n    "), a("span", { pre: !0, attrs: { class: "token function" } }, [t._v("commit")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token string" } }, [t._v('"SET_AUTHENTICATED"')]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(",")]), t._v(" authenticated"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v("\n  "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("}")]), t._v("\n"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("}")]), t._v("\n")])])]), a("p", [t._v("Тест для действия должен проверять:")]), t._v(" "), a("ol", [a("li", [t._v("правильный ли endpoint API использовался?")]), t._v(" "), a("li", [t._v("правильная ли нагрузка для мутации?")]), t._v(" "), a("li", [t._v("правильная ли мутация была использована?")])]), t._v(" "), a("p", [t._v("Давайте двигаться вперёд и напишем тест, пусть ошибки подсказывают нам что делать.")]), t._v(" "), a("h2", { attrs: { id: "написание-теста" } }, [a("a", { staticClass: "header-anchor", attrs: { href: "#написание-теста" } }, [t._v("#")]), t._v(" Написание теста")]), t._v(" "), a("div", { staticClass: "language-js extra-class" }, [a("pre", { pre: !0, attrs: { class: "language-js" } }, [a("code", [a("span", { pre: !0, attrs: { class: "token function" } }, [t._v("describe")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token string" } }, [t._v('"Авторизация"')]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(",")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token operator" } }, [t._v("=>")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("{")]), t._v("\n  "), a("span", { pre: !0, attrs: { class: "token function" } }, [t._v("it")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token string" } }, [t._v('"авторизует пользователя"')]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(",")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("async")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token operator" } }, [t._v("=>")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("{")]), t._v("\n    "), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("const")]), t._v(" commit "), a("span", { pre: !0, attrs: { class: "token operator" } }, [t._v("=")]), t._v(" jest"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(".")]), a("span", { pre: !0, attrs: { class: "token function" } }, [t._v("fn")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v("\n    "), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("const")]), t._v(" username "), a("span", { pre: !0, attrs: { class: "token operator" } }, [t._v("=")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token string" } }, [t._v('"alice"')]), t._v("\n    "), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("const")]), t._v(" password "), a("span", { pre: !0, attrs: { class: "token operator" } }, [t._v("=")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token string" } }, [t._v('"password"')]), t._v("\n\n    "), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("await")]), t._v(" actions"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(".")]), a("span", { pre: !0, attrs: { class: "token function" } }, [t._v("authenticate")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("{")]), t._v(" commit "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("}")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(",")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("{")]), t._v(" username"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(",")]), t._v(" password "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("}")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v("\n\n    "), a("span", { pre: !0, attrs: { class: "token function" } }, [t._v("expect")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), t._v("url"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(".")]), a("span", { pre: !0, attrs: { class: "token function" } }, [t._v("toBe")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token string" } }, [t._v('"/api/authenticate"')]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v("\n    "), a("span", { pre: !0, attrs: { class: "token function" } }, [t._v("expect")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), t._v("body"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(".")]), a("span", { pre: !0, attrs: { class: "token function" } }, [t._v("toEqual")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("{")]), t._v(" username"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(",")]), t._v(" password "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("}")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v("\n    "), a("span", { pre: !0, attrs: { class: "token function" } }, [t._v("expect")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), t._v("commit"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(".")]), a("span", { pre: !0, attrs: { class: "token function" } }, [t._v("toHaveBeenCalledWith")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), t._v("\n      "), a("span", { pre: !0, attrs: { class: "token string" } }, [t._v('"SET_AUTHENTICATED"')]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(",")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token boolean" } }, [t._v("true")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v("\n  "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("}")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v("\n"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("}")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v("\n")])])]), a("p", [t._v("Так как "), a("code", [t._v("axios")]), t._v(" асинхронный, нужно убедиться, что Jest дождётся окончания теста. Добавим "), a("code", [t._v("async")]), t._v(" для функции и "), a("code", [t._v("await")]), t._v(" для вызова "), a("code", [t._v("actions.authenticate")]), t._v(". В противном случае тест завершится до проверки "), a("code", [t._v("expect")]), t._v(", и мы получим тест, который всегда будет проходить проверку.")]), t._v(" "), a("p", [t._v("Запуск теста выше выдаст нам такую ошибку:")]), t._v(" "), a("div", { staticClass: "language-bash extra-class" }, [a("pre", { pre: !0, attrs: { class: "language-bash" } }, [a("code", [t._v(" FAIL  tests/unit/actions.spec.js\n  ● Авторизация › авторизует пользователя\n\n    SyntaxError: The string did not match the expected pattern.\n\n      at XMLHttpRequest.open "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), t._v("node_modules/jsdom/lib/jsdom/living/xmlhttprequest.js:482:15"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v("\n      at dispatchXhrRequest "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), t._v("node_modules/axios/lib/adapters/xhr.js:45:13"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v("\n      at xhrAdapter "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), t._v("node_modules/axios/lib/adapters/xhr.js:12:10"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v("\n      at dispatchRequest "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), t._v("node_modules/axios/lib/core/dispatchRequest.js:59:10"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v("\n")])])]), a("p", [t._v("Это ошибка возникает где-то внутри "), a("code", [t._v("axios")]), t._v(". Мы делаем запрос к "), a("code", [t._v("/api...")]), t._v(" и, так как мы запускаем тест в тестовом окружении, в котором даже нет сервера, получаем ошибку. Мы также не определили "), a("code", [t._v("url")]), t._v(" или "), a("code", [t._v("body")]), t._v(" – мы сделаем это, когда будем решать ошибку с "), a("code", [t._v("axios")]), t._v(".")]), t._v(" "), a("p", [t._v("Так как мы используем Jest, можно легко замокать вызов API, применяя "), a("code", [t._v("jest.mock")]), t._v(". Мы сделаем мок для "), a("code", [t._v("axios")]), t._v(", который даст нам больше контроля над его поведением. Jest предоставляет "), a("a", { attrs: { href: "https://jestjs.io/docs/ru/es6-class-mocks", target: "_blank", rel: "noopener noreferrer" } }, [t._v("моки для ES6 классов"), a("OutboundLink")], 1), t._v(", которые идеально подходят для мока "), a("code", [t._v("axios")]), t._v(".")]), t._v(" "), a("p", [t._v("Мок для "), a("code", [t._v("axios")]), t._v(" выглядит следующим образом:")]), t._v(" "), a("div", { staticClass: "language-js extra-class" }, [a("pre", { pre: !0, attrs: { class: "language-js" } }, [a("code", [a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("let")]), t._v(" url "), a("span", { pre: !0, attrs: { class: "token operator" } }, [t._v("=")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token string" } }, [t._v("''")]), t._v("\n"), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("let")]), t._v(" body "), a("span", { pre: !0, attrs: { class: "token operator" } }, [t._v("=")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("{")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("}")]), t._v("\n\njest"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(".")]), a("span", { pre: !0, attrs: { class: "token function" } }, [t._v("mock")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token string" } }, [t._v('"axios"')]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(",")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token operator" } }, [t._v("=>")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("{")]), t._v("\n  "), a("span", { pre: !0, attrs: { class: "token function-variable function" } }, [t._v("post")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(":")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token parameter" } }, [t._v("_url"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(",")]), t._v(" _body")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token operator" } }, [t._v("=>")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("{")]), t._v(" \n    "), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("return")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("new")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token class-name" } }, [t._v("Promise")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token parameter" } }, [t._v("resolve")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token operator" } }, [t._v("=>")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("{")]), t._v("\n      url "), a("span", { pre: !0, attrs: { class: "token operator" } }, [t._v("=")]), t._v(" _url\n      body "), a("span", { pre: !0, attrs: { class: "token operator" } }, [t._v("=")]), t._v(" _body\n      "), a("span", { pre: !0, attrs: { class: "token function" } }, [t._v("resolve")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token boolean" } }, [t._v("true")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v("\n    "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("}")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v("\n  "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("}")]), t._v("\n"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("}")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v("\n")])])]), a("p", [t._v("Мы сохраняем "), a("code", [t._v("url")]), t._v(" и "), a("code", [t._v("body")]), t._v(" в переменные, чтобы мы могли проверить, что правильный endpoint получает правильную нагрузку. Так как мы не хотим использовать настоящий endpoint, мы немедленно выполняем промис, что симулирует успешный вызов API.")]), t._v(" "), a("p", [a("code", [t._v("yarn test:unit")]), t._v(" теперь выводит сообщение, что тест прошёл проверку!")]), t._v(" "), a("h2", { attrs: { id: "тестирование-ошибки-api" } }, [a("a", { staticClass: "header-anchor", attrs: { href: "#тестирование-ошибки-api" } }, [t._v("#")]), t._v(" Тестирование ошибки API")]), t._v(" "), a("p", [t._v("Мы только протестировали случай, когда вызов API успешный. Важно тестировать все возможные случаи. Давайте напишем тест, в котором происходит ошибка. В этот раз, мы сначала напишем тест, а затем — реализацию.")]), t._v(" "), a("p", [t._v("Тест выглядит примерно так:")]), t._v(" "), a("div", { staticClass: "language-js extra-class" }, [a("pre", { pre: !0, attrs: { class: "language-js" } }, [a("code", [a("span", { pre: !0, attrs: { class: "token function" } }, [t._v("it")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token string" } }, [t._v('"ловит ошибки"')]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(",")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("async")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token operator" } }, [t._v("=>")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("{")]), t._v("\n  mockError "), a("span", { pre: !0, attrs: { class: "token operator" } }, [t._v("=")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token boolean" } }, [t._v("true")]), t._v("\n\n  "), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("await")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token function" } }, [t._v("expect")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), t._v("actions"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(".")]), a("span", { pre: !0, attrs: { class: "token function" } }, [t._v("authenticate")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("{")]), t._v(" commit"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(":")]), t._v(" jest"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(".")]), a("span", { pre: !0, attrs: { class: "token function" } }, [t._v("fn")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("}")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(",")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("{")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("}")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v("\n    "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(".")]), t._v("rejects"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(".")]), a("span", { pre: !0, attrs: { class: "token function" } }, [t._v("toThrow")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token string" } }, [t._v('"Произошла ошибка API."')]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v("\n"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("}")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v("\n")])])]), a("p", [t._v("Нам нужно найти способ заставить мок для "), a("code", [t._v("axios")]), t._v(" сгенерировать ошибку. Вот для чего нужна переменная "), a("code", [t._v("mockError")]), t._v(". Обновим мок для "), a("code", [t._v("axios")]), t._v(" вот так:")]), t._v(" "), a("div", { staticClass: "language-js extra-class" }, [a("pre", { pre: !0, attrs: { class: "language-js" } }, [a("code", [a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("let")]), t._v(" url "), a("span", { pre: !0, attrs: { class: "token operator" } }, [t._v("=")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token string" } }, [t._v("''")]), t._v("\n"), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("let")]), t._v(" body "), a("span", { pre: !0, attrs: { class: "token operator" } }, [t._v("=")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("{")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("}")]), t._v("\n"), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("let")]), t._v(" mockError "), a("span", { pre: !0, attrs: { class: "token operator" } }, [t._v("=")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token boolean" } }, [t._v("false")]), t._v("\n\njest"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(".")]), a("span", { pre: !0, attrs: { class: "token function" } }, [t._v("mock")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token string" } }, [t._v('"axios"')]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(",")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token operator" } }, [t._v("=>")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("{")]), t._v("\n  "), a("span", { pre: !0, attrs: { class: "token function-variable function" } }, [t._v("post")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(":")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token parameter" } }, [t._v("_url"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(",")]), t._v(" _body")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token operator" } }, [t._v("=>")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("{")]), t._v(" \n    "), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("return")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("new")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token class-name" } }, [t._v("Promise")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token parameter" } }, [t._v("resolve")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token operator" } }, [t._v("=>")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("{")]), t._v("\n      "), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("if")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), t._v("mockError"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v(" \n        "), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("throw")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token function" } }, [t._v("Error")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v("\n\n      url "), a("span", { pre: !0, attrs: { class: "token operator" } }, [t._v("=")]), t._v(" _url\n      body "), a("span", { pre: !0, attrs: { class: "token operator" } }, [t._v("=")]), t._v(" _body\n      "), a("span", { pre: !0, attrs: { class: "token function" } }, [t._v("resolve")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token boolean" } }, [t._v("true")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v("\n    "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("}")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v("\n  "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("}")]), t._v("\n"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("}")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v("\n")])])]), a("p", [t._v("Jest позволяет обращаться к переменной вне текущего лексического окружения ES6 класса только, если перед названием переменной стоит "), a("code", [t._v("mock")]), t._v(". Теперь мы можем с лёгкостью сделать "), a("code", [t._v("mockError = true")]), t._v(" и "), a("code", [t._v("axios")]), t._v(" сгенерирует ошибку.")]), t._v(" "), a("p", [t._v("Запуск теста выдаст нам такую ошибку:")]), t._v(" "), a("div", { staticClass: "language-bash extra-class" }, [a("pre", { pre: !0, attrs: { class: "language-bash" } }, [a("code", [t._v("FAIL  tests/unit/actions.spec.js\n● Авторизация › ловит ошибки\n\n  expect"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), t._v("function"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v(".toThrow"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), t._v("string"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v("\n\n  Expected the "), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("function")]), t._v(" to throw an error matching:\n    "), a("span", { pre: !0, attrs: { class: "token string" } }, [t._v('"Произошла ошибка API."')]), t._v("\n  Instead, it threw:\n    Mock error\n")])])]), a("p", [t._v("Он успешно словил ошибку... но не ту которую мы хотели. Обновим "), a("code", [t._v("authenticate")]), t._v(", чтобы генерировать ошибку, которая ожидается в тесте:")]), t._v(" "), a("div", { staticClass: "language-js extra-class" }, [a("pre", { pre: !0, attrs: { class: "language-js" } }, [a("code", [a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("export")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("default")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("{")]), t._v("\n  "), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("async")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token function" } }, [t._v("authenticate")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token parameter" } }, [a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("{")]), t._v(" commit "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("}")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(",")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("{")]), t._v(" username"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(",")]), t._v(" password "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("}")])]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("{")]), t._v("\n    "), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("try")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("{")]), t._v("\n      "), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("const")]), t._v(" authenticated "), a("span", { pre: !0, attrs: { class: "token operator" } }, [t._v("=")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("await")]), t._v(" axios"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(".")]), a("span", { pre: !0, attrs: { class: "token function" } }, [t._v("post")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token string" } }, [t._v('"/api/authenticate"')]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(",")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("{")]), t._v("\n        username"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(",")]), t._v(" password\n      "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("}")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v("\n\n      "), a("span", { pre: !0, attrs: { class: "token function" } }, [t._v("commit")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token string" } }, [t._v('"SET_AUTHENTICATED"')]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(",")]), t._v(" authenticated"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v("\n    "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("}")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("catch")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), t._v("e"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("{")]), t._v("\n      "), a("span", { pre: !0, attrs: { class: "token keyword" } }, [t._v("throw")]), t._v(" "), a("span", { pre: !0, attrs: { class: "token function" } }, [t._v("Error")]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("(")]), a("span", { pre: !0, attrs: { class: "token string" } }, [t._v('"Произошла ошибка API."')]), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v(")")]), t._v("\n    "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("}")]), t._v("\n  "), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("}")]), t._v("\n"), a("span", { pre: !0, attrs: { class: "token punctuation" } }, [t._v("}")]), t._v("\n")])])]), a("p", [t._v("Теперь тесты проходят проверку.")]), t._v(" "), a("h2", { attrs: { id: "уnучшения" } }, [a("a", { staticClass: "header-anchor", attrs: { href: "#уnучшения" } }, [t._v("#")]), t._v(" Улучшения")]), t._v(" "), a("p", [t._v("Теперь вы знаете, как тестировать действия в изоляции. Есть, как минимум, одно улучшение, которое можно сделать – это реализовать мок "), a("code", [t._v("axios")]), t._v(" в виде "), a("a", { attrs: { href: "https://jestjs.io/docs/ru/manual-mocks", target: "_blank", rel: "noopener noreferrer" } }, [t._v("пользовательского мока"), a("OutboundLink")], 1), t._v(". Необходимо создать папку "), a("code", [t._v("__mocks__")]), t._v(" на том же уровне, где находится "), a("code", [t._v("node_modules")]), t._v(", и реализовать мок модуль там. Сделав это, вы можете использовать реализацию мока во всех тестах. Jest автоматически использует мок реализации из "), a("code", [t._v("__mocks__")]), t._v(". На сайте Jest и в интернете есть множество примеров, как сделать это. Рефакторинг этого теста, используя пользовательский мок, остаётся как упражнение для читателя.")]), t._v(" "), a("h2", { attrs: { id: "закnючение" } }, [a("a", { staticClass: "header-anchor", attrs: { href: "#закnючение" } }, [t._v("#")]), t._v(" Заключение")]), t._v(" "), a("p", [t._v("В этом руководстве обсудили:")]), t._v(" "), a("ul", [a("li", [t._v("как использовать моки Jest для ES6 классов")]), t._v(" "), a("li", [t._v("как тестировать успешные и неудачные случаи действий")])]), t._v(" "), a("p", [t._v("Исходный код для теста на этой странице можно найти "), a("a", { attrs: { href: "https://github.com/lmiller1990/vue-testing-handbook/tree/master/demo-app/tests/unit/actions.spec.js", target: "_blank", rel: "noopener noreferrer" } }, [t._v("здесь"), a("OutboundLink")], 1), t._v(".")])]) }), [], !1, null, null, null); s.default = e.exports } }]);